<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filmangstream - Accueil</title>
    <style>
        /* --- DESIGN GLOBAL --- */
        body { background-color: #141414; color: white; font-family: Arial, sans-serif; margin: 0; padding: 0; height: 100vh; }
        
        /* --- SECTION CONNEXION --- */
        #auth-section { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .auth-box { background: rgba(0,0,0,0.85); padding: 40px; border-radius: 8px; width: 100%; max-width: 350px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .auth-box h2 { text-align: center; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #444; border-radius: 4px; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-primary { background: #e50914; color: white; margin-top: 10px; }
        .btn-primary:hover { background: #f40612; }
        .btn-google { background: white; color: black; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 15px; }
        .btn-google:hover { background: #e0e0e0; }
        .btn-google img { width: 20px; }
        .toggle-link { text-align: center; margin-top: 20px; color: #b3b3b3; font-size: 14px; cursor: pointer; }
        .toggle-link:hover { text-decoration: underline; color: white; }
        .divider { text-align: center; margin: 20px 0; color: #777; font-size: 12px; position: relative; }
        .divider::before, .divider::after { content: ""; position: absolute; top: 50%; width: 35%; height: 1px; background: #444; }
        .divider::before { left: 0; }
        .divider::after { right: 0; }

        /* --- SECTION CATALOGUE DE FILMS --- */
        #app-section { display: none; padding: 20px; } /* Caché par défaut */
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #333; }
        header h1 { color: #e50914; margin: 0; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        #logout-btn { background: transparent; color: white; border: 1px solid white; padding: 8px 15px; width: auto; font-size: 14px; }
        #logout-btn:hover { background: white; color: black; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .film-card { background: #222; height: 300px; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-align: center; border: 1px solid #333; transition: transform 0.2s; }
        .film-card:hover { transform: scale(1.05); cursor: pointer; border-color: #e50914; }

        /* --- ECRAN DE CHARGEMENT --- */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #141414; display: flex; justify-content: center; align-items: center; z-index: 9999; }
    </style>

    <script src="https://www.google.com/recaptcha/api.js?render=6LeusWosAAAAAA-CQ-p7CjxB3FsPm6X9E3Rve3FL"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
</head>
<body>

    <div id="loading-screen">
        <h2 style="color: #e50914;">Chargement de Filmangstream...</h2>
    </div>

    <div id="auth-section">
        <div class="auth-box">
            <h2 id="form-title">S'identifier</h2>
            
            <form id="auth-form">
                <input type="email" id="email" placeholder="E-mail" required>
                <input type="password" id="password" placeholder="Mot de passe (6 car. min)" required>
                <button type="submit" id="submit-btn" class="btn-primary">S'identifier</button>
            </form>

            <div class="divider">OU</div>

            <button id="google-btn" class="btn-google">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google">
                Continuer avec Google
            </button>

            <p class="toggle-link" id="toggle-mode">Première fois sur Filmangstream ? S'inscrire.</p>
        </div>
    </div>

    <div id="app-section">
        <header>
            <h1>FILMANGSTREAM</h1>
            <div class="user-info">
                <span id="user-email"></span>
                <button id="logout-btn">Se déconnecter</button>
            </div>
        </header>

        <h2>Films et Séries du moment</h2>
        <div class="grid">
            <div class="film-card"><h3>Film 1<br>(Affiche)</h3></div>
            <div class="film-card"><h3>Film 2<br>(Affiche)</h3></div>
            <div class="film-card"><h3>Film 3<br>(Affiche)</h3></div>
            <div class="film-card"><h3>Film 4<br>(Affiche)</h3></div>
        </div>
    </div>

    <script>
        // 1. CONFIGURATION APPWRITE
        const { Client, Account, ID } = Appwrite;
        const client = new Client()
            .setEndpoint('https://cloud.appwrite.io/v1') 
            .setProject('698f97e3001c4c48d6d7'); 

        const account = new Account(client);

        // Variables des sections
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const loadingScreen = document.getElementById('loading-screen');

        // --- FONCTIONS DE NAVIGATION ---
        function showApp(email) {
            authSection.style.display = 'none';      // Cache le formulaire
            loadingScreen.style.display = 'none';    // Cache le chargement
            appSection.style.display = 'block';      // Affiche les films
            document.getElementById('user-email').innerText = email; // Affiche l'email en haut
        }

        function showAuth() {
            appSection.style.display = 'none';       // Cache les films
            loadingScreen.style.display = 'none';    // Cache le chargement
            authSection.style.display = 'flex';      // Affiche le formulaire
        }

        // --- VÉRIFICATION AU DÉMARRAGE ---
        // Quand la page s'ouvre, on vérifie si l'utilisateur est déjà connecté
        account.get().then((response) => {
            // Utilisateur connecté ! On affiche direct les films
            showApp(response.email || "Utilisateur Google");
        }).catch(() => {
            // Utilisateur non connecté, on affiche la page de connexion
            showAuth();
        });

        // --- GESTION DU MODE (Connexion ou Inscription) ---
        let isSignUpMode = false;
        const formTitle = document.getElementById('form-title');
        const btnSubmit = document.getElementById('submit-btn');
        const btnToggle = document.getElementById('toggle-mode');

        btnToggle.onclick = () => {
            isSignUpMode = !isSignUpMode;
            formTitle.innerText = isSignUpMode ? "Créer un compte" : "S'identifier";
            btnSubmit.innerText = isSignUpMode ? "S'inscrire" : "S'identifier";
            btnToggle.innerText = isSignUpMode ? "Déjà membre ? Se connecter." : "Première fois sur Filmangstream ? S'inscrire.";
        };

        // --- CONNEXION AVEC GOOGLE ---
        document.getElementById('google-btn').onclick = () => {
            // On utilise la page actuelle (window.location.href) pour le succès et l'échec
            account.createOAuth2Session('google', window.location.href, window.location.href);
        };

        // --- SOUMISSION DU FORMULAIRE (Email/Mot de passe) ---
        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (password.length < 6) {
                alert("Le mot de passe doit contenir au moins 6 caractères.");
                return;
            }

            // Afficher le chargement pendant la requête
            loadingScreen.style.display = 'flex';

            // Exécution du reCAPTCHA
            grecaptcha.ready(function() {
                grecaptcha.execute('6LeusWosAAAAAA-CQ-p7CjxB3FsPm6X9E3Rve3FL', {action: 'submit'}).then(async (token) => {
                    try {
                        if (isSignUpMode) {
                            // Création du compte puis connexion automatique
                            await account.create(ID.unique(), email, password);
                            await account.createEmailPasswordSession(email, password);
                        } else {
                            // Connexion classique
                            await account.createEmailPasswordSession(email, password);
                        }
                        
                        // Succès ! On récupère les infos de l'utilisateur et on affiche les films
                        const user = await account.get();
                        showApp(user.email);

                    } catch (error) {
                        loadingScreen.style.display = 'none';
                        alert("Erreur : " + error.message);
                    }
                });
            });
        };

        // --- DÉCONNEXION ---
        document.getElementById('logout-btn').onclick = async () => {
            loadingScreen.style.display = 'flex';
            try {
                await account.deleteSession('current');
                // On vide les champs du formulaire et on raffiche la connexion
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                showAuth();
            } catch (error) {
                loadingScreen.style.display = 'none';
                alert("Erreur lors de la déconnexion.");
            }
        };
    </script>
</body>
</html>
