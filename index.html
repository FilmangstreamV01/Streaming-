<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filmangstream | Cinéma Illimité</title>
    
    <!-- SDKs -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>
    <script src="https://www.google.com/recaptcha/api.js?render=6Lf1CVYsAAAAAJV-_MtXBBUBGfwCIRkE2x75adLl"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #E50914;
            --dark: #080808;
            --glass: rgba(20, 20, 20, 0.75);
            --border: rgba(255, 255, 255, 0.1);
            --transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* --- BASE --- */
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Montserrat', sans-serif;
            background-color: var(--dark); color: white;
            overflow-x: hidden;
        }

        /* --- BACKGROUND GLOBAL --- */
        #global-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; background-size: cover; background-position: center;
            transition: transform 10s ease, opacity 1s ease;
            transform: scale(1.1); filter: brightness(0.4) blur(0px);
        }
        .vignette {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 0%, #000 90%);
            z-index: -1; pointer-events: none;
        }

        /* --- SECTION 1: AUTHENTIFICATION --- */
        #auth-section {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; width: 100%;
            transition: opacity 0.8s ease, transform 0.8s ease;
            position: absolute; top: 0; left: 0; z-index: 50;
        }

        .brand-big {
            font-size: 3.5rem; font-weight: 900; color: var(--primary);
            text-transform: uppercase; letter-spacing: -2px;
            margin-bottom: 40px; text-shadow: 0 10px 30px rgba(229, 9, 20, 0.5);
            animation: fadeInDown 1s ease-out;
        }

        .auth-card {
            background: var(--glass); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 20px;
            padding: 50px 40px; width: 100%; max-width: 440px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            position: relative; overflow: hidden;
        }
        
        /* Neon Line Top */
        .auth-card::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            box-shadow: 0 2px 15px var(--primary);
        }

        .input-wrap { position: relative; margin-bottom: 20px; }
        .input-wrap input {
            width: 100%; padding: 16px 20px 16px 50px;
            background: rgba(0,0,0,0.4); border: 1px solid var(--border);
            border-radius: 8px; color: white; font-family: inherit;
            transition: 0.3s;
        }
        .input-wrap input:focus {
            border-color: var(--primary); background: rgba(0,0,0,0.7);
            box-shadow: 0 0 0 4px rgba(229, 9, 20, 0.15); outline: none;
        }
        .input-wrap i {
            position: absolute; left: 18px; top: 50%; transform: translateY(-50%);
            color: #888; pointer-events: none;
        }

        .btn-action {
            width: 100%; padding: 16px; background: var(--primary);
            color: white; font-weight: 800; border: none; border-radius: 8px;
            cursor: pointer; font-size: 1rem; text-transform: uppercase;
            transition: var(--transition); margin-top: 10px;
        }
        .btn-action:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(229, 9, 20, 0.4); }

        .switch-link {
            text-align: center; margin-top: 25px; font-size: 0.9rem; color: #bbb;
        }
        .switch-link span { color: white; cursor: pointer; font-weight: 700; text-decoration: underline; }

        .hidden { display: none !important; }
        .fade-out { opacity: 0; pointer-events: none; transform: scale(1.1); }


        /* --- SECTION 2: PLATEFORME (App) --- */
        #app-section {
            opacity: 0; pointer-events: none;
            transition: opacity 1.5s ease;
            width: 100%; min-height: 100vh;
        }
        #app-section.active { opacity: 1; pointer-events: auto; }

        /* Navbar */
        .navbar {
            position: fixed; top: 0; width: 100%; padding: 20px 5%;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
        }
        .nav-logo { font-weight: 900; font-size: 1.5rem; color: var(--primary); letter-spacing: -1px; }
        
        /* Hero */
        .hero {
            height: 80vh; display: flex; align-items: center; padding: 0 5%;
            background: linear-gradient(to right, #000 0%, transparent 60%);
            position: relative; z-index: 10;
        }
        .hero-info { max-width: 600px; animation: slideRight 1s ease 0.5s backwards; }
        .hero-title { font-size: 3.5rem; line-height: 1.1; margin-bottom: 20px; text-transform: uppercase; }
        .hero-desc { font-size: 1.1rem; color: #ddd; margin-bottom: 30px; line-height: 1.6; }
        
        .hero-btns button {
            padding: 12px 35px; font-size: 1.1rem; font-weight: 700; border: none; border-radius: 4px;
            cursor: pointer; margin-right: 15px; display: inline-flex; align-items: center; gap: 10px;
        }
        .btn-play { background: white; color: black; }
        .btn-info { background: rgba(109,109,109,0.7); color: white; backdrop-filter: blur(5px); }

        /* Rows */
        .content-container { margin-top: -100px; position: relative; z-index: 20; padding-bottom: 50px; }
        .row { margin: 30px 0 0 5%; }
        .row-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; color: #e5e5e5; }
        .row-scroller {
            display: flex; gap: 10px; overflow-x: auto; padding: 20px 0;
            scrollbar-width: none;
        }
        .row-scroller::-webkit-scrollbar { display: none; }
        
        .card {
            min-width: 200px; height: 300px; background: #222; border-radius: 6px;
            background-size: cover; transition: transform 0.3s ease; cursor: pointer;
        }
        .card:hover { transform: scale(1.1); z-index: 50; border: 2px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }

        @keyframes fadeInDown { from {opacity:0; transform:translateY(-50px);} to {opacity:1; transform:translateY(0);} }
        @keyframes slideRight { from {opacity:0; transform:translateX(-50px);} to {opacity:1; transform:translateX(0);} }
    </style>
</head>
<body>

    <!-- FOND UNIQUE DYNAMIQUE -->
    <div id="global-bg"></div>
    <div class="vignette"></div>

    <!-- --- ETAPE 1 : AUTHENTIFICATION --- -->
    <section id="auth-section">
        <div class="brand-big">Filmangstream</div>
        
        <!-- Login Form -->
        <div id="login-form" class="auth-card">
            <h2 style="margin-top:0;">Bon retour</h2>
            
            <div class="input-wrap">
                <input type="email" id="l-email" placeholder="Email">
                <i class="fa-solid fa-envelope"></i>
            </div>
            <div class="input-wrap">
                <input type="password" id="l-pass" placeholder="Mot de passe">
                <i class="fa-solid fa-lock"></i>
            </div>
            <div id="l-error" style="color:#ff4d4d; font-size:0.8rem; margin-bottom:10px;"></div>

            <button class="btn-action" onclick="login()">Se Connecter</button>
            
            <div class="switch-link">
                Nouveau ? <span onclick="toggleAuth('reg')">Créer un compte</span>
            </div>
        </div>

        <!-- Register Form -->
        <div id="register-form" class="auth-card hidden">
            <h2 style="margin-top:0;">Créer un compte</h2>
            
            <div class="input-wrap">
                <input type="email" id="r-email" placeholder="Votre Email">
                <i class="fa-solid fa-at"></i>
            </div>
            <div class="input-wrap">
                <input type="password" id="r-pass" placeholder="Mot de passe fort">
                <i class="fa-solid fa-key"></i>
            </div>
            <div id="r-error" style="color:#ff4d4d; font-size:0.8rem; margin-bottom:10px;"></div>

            <button class="btn-action" onclick="register()">Commencer</button>
            
            <div class="switch-link">
                Déjà membre ? <span onclick="toggleAuth('log')">Connexion</span>
                <br><small style="opacity:0.5; font-size:0.7rem;">Protected by reCAPTCHA</small>
            </div>
        </div>
    </section>

    <!-- --- ETAPE 2 : PLATEFORME STREAMING --- -->
    <section id="app-section">
        <nav class="navbar">
            <div class="nav-logo">FILMANGSTREAM</div>
            <div style="display:flex; gap:20px; align-items:center;">
                <i class="fa-solid fa-magnifying-glass"></i>
                <div style="width:30px; height:30px; background:red; border-radius:4px; cursor:pointer;" onclick="logout()"></div>
            </div>
        </nav>

        <header class="hero">
            <div class="hero-info">
                <h1 class="hero-title" id="hero-title">Chargement...</h1>
                <p class="hero-desc" id="hero-desc">Sélection des meilleurs films en cours...</p>
                <div class="hero-btns">
                    <button class="btn-play"><i class="fa-solid fa-play"></i> Lecture</button>
                    <button class="btn-info"><i class="fa-solid fa-circle-info"></i> Plus d'infos</button>
                </div>
            </div>
        </header>

        <div class="content-container" id="rows-wrapper">
            <!-- JS injectera les films ici -->
        </div>
    </section>

    <script>
        // --- CONFIGURATION ---
        const { Client, Account, ID } = Appwrite;
        const client = new Client().setEndpoint('https://cloud.appwrite.io/v1').setProject('698f97e3001c4c48d6d7');
        const account = new Account(client);

        const TMDB_KEY = '7b5c62a2d80f0a3d2e86a622cb23f0db';
        const IMG_HD = 'https://image.tmdb.org/t/p/original';
        const IMG_SD = 'https://image.tmdb.org/t/p/w500';

        // --- GESTION BACKGROUND INTELLIGENT ---
        let bgImages = [];
        async function initBackgrounds() {
            try {
                const res = await fetch(`https://api.themoviedb.org/3/trending/movie/week?api_key=${TMDB_KEY}`);
                const data = await res.json();
                bgImages = data.results.map(m => m.backdrop_path).filter(p => p);
                
                // Mettre la première image tout de suite
                if(bgImages.length > 0) {
                    document.getElementById('global-bg').style.backgroundImage = `url('${IMG_HD}${bgImages[0]}')`;
                }

                // Rotation si on est sur le login
                let idx = 0;
                setInterval(() => {
                    const authSection = document.getElementById('auth-section');
                    // On ne change le fond que si on est sur le login OU pour garder l'ambiance
                    if(!authSection.classList.contains('fade-out')) {
                        idx = (idx + 1) % bgImages.length;
                        document.getElementById('global-bg').style.backgroundImage = `url('${IMG_HD}${bgImages[idx]}')`;
                    }
                }, 8000);

            } catch(e) { console.log("Bg Error", e); }
        }
        initBackgrounds();

        // --- AUTHENTIFICATION ---
        function toggleAuth(mode) {
            const l = document.getElementById('login-form');
            const r = document.getElementById('register-form');
            if(mode === 'reg') { l.classList.add('hidden'); r.classList.remove('hidden'); }
            else { r.classList.add('hidden'); l.classList.remove('hidden'); }
        }

        async function login() {
            const email = document.getElementById('l-email').value;
            const pass = document.getElementById('l-pass').value;
            if(!email || !pass) return alert("Champs vides");

            try {
                await account.createEmailPasswordSession(email, pass);
                transitionToApp();
            } catch(e) {
                document.getElementById('l-error').innerText = "Identifiants incorrects";
            }
        }

        async function register() {
            const email = document.getElementById('r-email').value;
            const pass = document.getElementById('r-pass').value;
            if(!email || !pass) return alert("Champs vides");

            try {
                // Captcha v3 execution (token non utilisé dans cet exemple simple mais présent pour la forme)
                await grecaptcha.execute('6Lf1CVYsAAAAAJV-_MtXBBUBGfwCIRkE2x75adLl', {action: 'register'});
                
                await account.create(ID.unique(), email, pass);
                await account.createEmailPasswordSession(email, pass);
                transitionToApp();
            } catch(e) {
                document.getElementById('r-error').innerText = e.message;
            }
        }

        // --- TRANSITION FLUIDE (SPA) ---
        function transitionToApp() {
            // 1. Cacher Login
            const auth = document.getElementById('auth-section');
            auth.classList.add('fade-out');
            
            // 2. Nettoyer le flou du background pour le mode film
            const bg = document.getElementById('global-bg');
            bg.style.filter = "blur(0px) brightness(0.6)";

            // 3. Charger le contenu App
            loadAppContent();

            // 4. Afficher App
            setTimeout(() => {
                auth.style.display = 'none';
                document.getElementById('app-section').classList.add('active');
            }, 800);
        }

        // --- LOGIQUE PLATEFORME ---
        async function loadAppContent() {
            // A. Hero Banner (Film aléatoire récent)
            const heroRes = await fetch(`https://api.themoviedb.org/3/movie/now_playing?api_key=${TMDB_KEY}&language=fr-FR`);
            const heroData = await heroRes.json();
            const heroMovie = heroData.results[0]; // Le plus populaire du moment

            document.getElementById('hero-title').innerText = heroMovie.title;
            document.getElementById('hero-desc').innerText = heroMovie.overview;
            // On force le background global sur le film du Hero
            document.getElementById('global-bg').style.backgroundImage = `url('${IMG_HD}${heroMovie.backdrop_path}')`;

            // B. Créer les rangées
            createRow("Populaires sur Filmangstream", `https://api.themoviedb.org/3/trending/movie/week?api_key=${TMDB_KEY}&language=fr-FR`);
            createRow("Séries incontournables", `https://api.themoviedb.org/3/trending/tv/week?api_key=${TMDB_KEY}&language=fr-FR`);
            createRow("Action & Aventure", `https://api.themoviedb.org/3/discover/movie?api_key=${TMDB_KEY}&with_genres=28&language=fr-FR`);
            createRow("Comédies", `https://api.themoviedb.org/3/discover/movie?api_key=${TMDB_KEY}&with_genres=35&language=fr-FR`);
        }

        async function createRow(title, url) {
            const wrapper = document.getElementById('rows-wrapper');
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row';
            rowDiv.innerHTML = `<div class="row-title">${title}</div><div class="row-scroller"></div>`;
            wrapper.appendChild(rowDiv);

            const scroller = rowDiv.querySelector('.row-scroller');
            const res = await fetch(url);
            const data = await res.json();

            data.results.forEach(m => {
                if(m.poster_path) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.backgroundImage = `url('${IMG_SD}${m.poster_path}')`;
                    card.onclick = () => {
                        // Change le background global au clic
                        document.getElementById('global-bg').style.backgroundImage = `url('${IMG_HD}${m.backdrop_path}')`;
                        document.getElementById('hero-title').innerText = m.title || m.name;
                        document.getElementById('hero-desc').innerText = m.overview;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    };
                    scroller.appendChild(card);
                }
            });
        }

        async function logout() {
            await account.deleteSession('current');
            window.location.reload();
        }

        // --- CHECK INITIAL ---
        async function init() {
            try {
                await account.get(); // Vérifie session
                transitionToApp();   // Si ok, on lance l'app direct
            } catch(e) {
                // Sinon on reste sur le login
                console.log("Utilisateur non connecté");
            }
        }
        init();

    </script>
</body>
    </html>
    
