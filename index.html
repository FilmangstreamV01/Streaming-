<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>FilmangStream - Player MovieBox</title>
<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:'Montserrat',system-ui,sans-serif;}
header{padding:16px;font-size:24px;text-align:center;background:#e50914;font-weight:700;letter-spacing:1px;}
.section{padding:16px;}
.section h3{margin-bottom:12px;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px;}
.card{background:#161616;border-radius:12px;overflow:hidden;transition:transform .2s;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.5);}
.card:hover{transform:scale(1.05)}
.card img{width:100%;display:block;}
.card p{margin:6px;font-size:14px;text-align:center;font-weight:500;}

/* Player UI */
#playerUI{position:fixed;inset:0;background:#000;display:none;flex-direction:column;z-index:9999;}
#topbar{display:flex;align-items:center;gap:10px;padding:10px;background:linear-gradient(to bottom,#000,#000a);}
select,button{background:#222;color:#fff;border:none;border-radius:8px;padding:6px 10px;font-size:14px;cursor:pointer;}
button:hover,select:hover{background:#333;}
#downloadBtn{background:#e50914;font-weight:700;}
#downloadBtn:hover{background:#ff1a2f;}

/* Player + playlist */
#playerContent{flex:1;display:flex;flex-direction:row;gap:10px;padding:10px;}
#playerBox{flex:3;position:relative;}
#playerBox iframe{position:absolute;inset:0;width:100%;height:100%;border:none;border-radius:8px;}
#playlist{flex:1;overflow-y:auto;}
#playlist .card{margin-bottom:10px;}
#playlist .card p{font-size:12px;}
#playlist .card.active{border:2px solid #e50914;}
</style>
</head>

<body>
<header>üé¨ FilmangStream</header>

<div class="section">
<h3>üé¨ Films</h3>
<div id="movies" class="grid"></div>
</div>
<div class="section">
<h3>üì∫ S√©ries</h3>
<div id="series" class="grid"></div>
</div>
<div class="section">
<h3>üç• Anime</h3>
<div id="anime" class="grid"></div>
</div>

<!-- PLAYER -->
<div id="playerUI">
  <div id="topbar">
    <button onclick="closePlayer()">‚¨Ö Retour</button>
    <select id="season" style="display:none"></select>
    <select id="episode" style="display:none"></select>
    <select id="language">
      <option value="fr">VF</option>
      <option value="en">VO</option>
      <option value="es">ES</option>
    </select>
    <button onclick="switchSource()">üîÅ Source</button>
    <button id="downloadBtn" onclick="downloadVideo()">‚¨á T√©l√©charger</button>
  </div>

  <div id="playerContent">
    <div id="playerBox"></div>
    <div id="playlist"></div>
  </div>
</div>

<script>
const API="https://api.themoviedb.org/3";
const KEY="1073e4d36ef71f912da093a5eb38f091";
const IMG="https://image.tmdb.org/t/p/w500";

let current={}, sourceIndex=0;
const moviesGrid=document.getElementById("movies");
const seriesGrid=document.getElementById("series");
const animeGrid=document.getElementById("anime");

const playerUI=document.getElementById("playerUI");
const playerBox=document.getElementById("playerBox");
const playlist=document.getElementById("playlist");
const season=document.getElementById("season");
const episode=document.getElementById("episode");
const languageSelect=document.getElementById("language");
const downloadBtn=document.getElementById("downloadBtn");

const SOURCES={
  movie:[
    (id,lang)=>`https://multiembed.mov/?video_id=${id}&lang=${lang}`,
    (id,lang)=>`https://vidsrc.to/embed/movie/${id}?lang=${lang}`,
    (id,lang)=>`https://letsembed.cc/embed/movie/${id}?lang=${lang}`
  ],
  tv:[
    (id,s,e,lang)=>`https://multiembed.mov/?video_id=${id}&s=${s}&e=${e}&lang=${lang}`,
    (id,s,e,lang)=>`https://vidsrc.to/embed/tv/${id}/${s}/${e}?lang=${lang}`,
    (id,s,e,lang)=>`https://letsembed.cc/embed/tv/${id}/${s}/${e}?lang=${lang}`
  ]
};

async function get(u){return(await fetch(u)).json();}
function card(container,item,type){
  if(!item.poster_path)return;
  const d=document.createElement("div");
  d.className="card";
  d.innerHTML=`<img src="${IMG+item.poster_path}"><p>${item.title||item.name}</p>`;
  d.onclick=()=>openContent(type,item.id);
  container.appendChild(d);
}

async function loadHome(){
  (await get(`${API}/movie/popular?api_key=${KEY}&language=fr`)).results.forEach(x=>card(moviesGrid,x,"movie"));
  (await get(`${API}/tv/popular?api_key=${KEY}&language=fr`)).results.forEach(x=>card(seriesGrid,x,"tv"));
  (await get(`${API}/discover/tv?api_key=${KEY}&with_genres=16&language=fr`)).results.forEach(x=>card(animeGrid,x,"tv"));
}

async function openContent(type,id){
  playerUI.style.display="flex";
  playerBox.innerHTML="";
  playlist.innerHTML="";
  season.style.display="none";
  episode.style.display="none";
  sourceIndex=0;

  current={type,id};

  if(type==="movie"){
    play();
    addMoviePlaylist(id);
  }else{
    const tv=await get(`${API}/tv/${id}?api_key=${KEY}&language=fr`);
    season.innerHTML="<option>Saison</option>";
    tv.seasons.forEach(s=>{
      if(s.season_number>0) season.innerHTML+=`<option value="${s.season_number}">Saison ${s.season_number}</option>`;
    });
    season.style.display="block";
  }
}

season.onchange=async()=>{
  current.season=season.value;
  const e=await get(`${API}/tv/${current.id}/season/${current.season}?api_key=${KEY}&language=fr`);
  episode.innerHTML="<option>√âpisode</option>";
  e.episodes.forEach(ep=>{
    episode.innerHTML+=`<option value="${ep.episode_number}">${ep.episode_number}. ${ep.name}</option>`;
  });
  episode.style.display="block";
  buildPlaylist(e.episodes);
}

episode.onchange=()=>{current.episode=episode.value; play();}
languageSelect.onchange=()=>{play();}

function play(nextIndex){
  if(current.type==="tv" && (!current.season || !current.episode)) return;
  const iframe=document.createElement("iframe");
  iframe.allow="autoplay; fullscreen";
  iframe.allowFullscreen=true;
  const lang=languageSelect.value;

  const src=current.type==="movie"
    ? SOURCES.movie[sourceIndex](current.id,lang)
    : SOURCES.tv[sourceIndex](current.id,current.season,current.episode,lang);

  iframe.src=src;
  playerBox.innerHTML="";
  playerBox.appendChild(iframe);

  downloadBtn.href=src;
  downloadBtn.download=`${current.type}_${current.id}.mp4`;

  // Highlight current in playlist
  Array.from(playlist.children).forEach((c,i)=>{
    c.classList.toggle("active", i==nextIndex || (current.type==="movie" && i==0));
  });
}

function switchSource(){sourceIndex++;if(current.type==="movie" && sourceIndex>=SOURCES.movie.length) sourceIndex=0;if(current.type==="tv" && sourceIndex>=SOURCES.tv.length) sourceIndex=0;play();}

function downloadVideo(){
  const a=document.createElement("a");
  a.href=downloadBtn.href;
  a.download=downloadBtn.download;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function closePlayer(){playerUI.style.display="none"; playerBox.innerHTML=""; playlist.innerHTML="";}

function buildPlaylist(episodes){
  playlist.innerHTML="";
  episodes.forEach((ep,i)=>{
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`<img src="${IMG+ep.still_path}"><p>${ep.episode_number}. ${ep.name}</p>`;
    d.onclick=()=>{
      current.episode=ep.episode_number;
      play(i);
    };
    playlist.appendChild(d);
  });
}

// Pour films, on peut simuler une playlist avec 1 √©l√©ment
function addMoviePlaylist(id){
  const d=document.createElement("div");
  d.className="card active";
  d.innerHTML=`<p>Film ID ${id}</p>`;
  playlist.appendChild(d);
}

loadHome();
</script>
</body>
</html>
