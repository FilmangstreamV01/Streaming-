<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FilmangStream NextGen VF/VO</title>
<style>
body {margin:0; background:#0b0b0b; color:#fff; font-family:system-ui;}
header {padding:14px; font-size:22px; text-align:center; background:#e50914;}
.section {padding:14px;}
.grid {display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px;}
.card {background:#161616; border-radius:14px; overflow:hidden; transition:.2s; cursor:pointer;}
.card:active {transform:scale(.97);}
.card img {width:100%;}
.card p {margin:6px; font-size:13px; text-align:center;}
#playerUI {position:fixed; inset:0; background:#000; display:none; flex-direction:column; z-index:9999;}
#topbar {display:flex; gap:8px; padding:10px; background:linear-gradient(#000,#000a); align-items:center;}
select,button{background:#222;color:#fff;border:none;border-radius:10px;padding:8px 10px;font-size:14px;}
#playerBox{flex:1; position:relative;}
#playerBox iframe{position:absolute; inset:0; width:100%; height:100%; border:none;}
.badge{font-size:11px;color:#aaa;}
#errorMsg{color:red;text-align:center;padding:10px;}
</style>
</head>
<body>

<header>üé¨ FilmangStream NextGen VF/VO</header>

<div class="section">
<h3>üé¨ Films</h3>
<div id="movies" class="grid"></div>
</div>

<div class="section">
<h3>üì∫ S√©ries</h3>
<div id="series" class="grid"></div>
</div>

<div class="section">
<h3>üç• Anime</h3>
<div id="anime" class="grid"></div>
</div>

<!-- PLAYER -->
<div id="playerUI">
  <div id="topbar">
    <button onclick="closePlayer()">‚¨Ö</button>
    <select id="season" style="display:none"></select>
    <select id="episode" style="display:none"></select>
    <select id="lang"></select>
    <button onclick="switchSource()">üîÅ Source</button>
    <span class="badge" id="sourceLabel"></span>
  </div>
  <div id="playerBox"></div>
  <div id="errorMsg"></div>
</div>

<script>
const API = "https://api.themoviedb.org/3";
const KEY = "1073e4d36ef71f912da093a5eb38f091";
const IMG = "https://image.tmdb.org/t/p/w500";

let current = {};
let sourceIndex = 0;

// Multi-sources NextGen
const SOURCES = {
  movie: [
    id => `https://player.embed-api.stream/?id=${id}`,
    id => `https://moviesapi.pro/movie/${id}`,
    id => `https://player.vidplus.to/embed/movie/${id}`
  ],
  tv: [
    (id,s,e) => `https://player.embed-api.stream/?id=${id}&s=${s}&e=${e}`,
    (id,s,e) => `https://moviesapi.pro/tv/${id}/${s}/${e}`,
    (id,s,e) => `https://player.vidplus.to/embed/tv/${id}&s=${s}&e=${e}`
  ]
};

// Charger TMDb
async function get(url){ return (await fetch(url)).json(); }

function card(container,item,type){
  if(!item.poster_path) return;
  const d=document.createElement("div");
  d.className="card";
  d.innerHTML = `<img src="${IMG+item.poster_path}"><p>${item.title||item.name}</p>`;
  d.onclick = () => openContent(type,item.id);
  container.appendChild(d);
}

async function loadHome(){
  (await get(`${API}/movie/popular?api_key=${KEY}&language=fr`)).results.forEach(x=>card(movies,x,"movie"));
  (await get(`${API}/tv/popular?api_key=${KEY}&language=fr`)).results.forEach(x=>card(series,x,"tv"));
  (await get(`${API}/discover/tv?api_key=${KEY}&with_genres=16&language=fr`)).results.forEach(x=>card(anime,x,"tv"));
}

// Ouvrir un contenu
async function openContent(type,id){
  playerUI.style.display="flex";
  playerBox.innerHTML="";
  season.style.display="none";
  episode.style.display="none";
  document.getElementById('errorMsg').textContent = "";
  sourceIndex = 0;

  current = {type,id,season:1,episode:1,lang:"french",availableLangs:["french","english"]};

  // Menu langue dynamique bas√© sur API
  const audioData = await fetchAvailableAudio(type,id);
  current.availableLangs = audioData.length>0 ? audioData : ["french","english"];
  populateLangMenu();

  if(type==="movie"){ play(); updateSourceLabel(); }
  else {
    const tv = await get(`${API}/tv/${id}?api_key=${KEY}&language=fr`);
    season.innerHTML = "<option>Saison</option>";
    tv.seasons.forEach(s=>{
      if(s.season_number>0)
        season.innerHTML += `<option value="${s.season_number}">Saison ${s.season_number}</option>`;
    });
    season.style.display="block";
  }
}

// Fetch pistes audio disponibles (simulation, adapter selon API)
async function fetchAvailableAudio(type,id){
  try{
    // Exemple endpoint MoviesAPI
    const url = type==="movie"
      ? `https://moviesapi.pro/api/movie/${id}/audio`
      : `https://moviesapi.pro/api/tv/${id}/season/1/episode/1/audio`;
    const res = await fetch(url);
    const data = await res.json();
    if(data && data.audio && data.audio.length>0){
      return data.audio.map(a => a.language.toLowerCase());
    }
    return [];
  }catch(e){ return []; }
}

function populateLangMenu(){
  lang.innerHTML = "";
  current.availableLangs.forEach(l => { lang.innerHTML += `<option value="${l}">${l.toUpperCase()}</option>`; });
  current.lang = current.availableLangs[0];
}

// Changement de saison/√©pisode/langue
season.onchange = async () => {
  current.season = season.value;
  const e = await get(`${API}/tv/${current.id}/season/${current.season}?api_key=${KEY}&language=fr`);
  episode.innerHTML="<option>√âpisode</option>";
  e.episodes.forEach(ep=>{
    episode.innerHTML += `<option value="${ep.episode_number}">√âpisode ${ep.episode_number}</option>`;
  });
  episode.style.display="block";
}

episode.onchange = () => { current.episode = episode.value; play(); updateSourceLabel(); }
lang.onchange = () => { current.lang = lang.value; play(); updateSourceLabel(); }

// Lecture avec fallback automatique et langue exacte
function play(){
  const iframe = document.createElement("iframe");
  iframe.allow = "autoplay; fullscreen";
  iframe.allowFullscreen = true;

  let src;
  if(current.type==="movie")
    src = SOURCES.movie[sourceIndex](current.id)+`?audio=${current.lang}`;
  else
    src = SOURCES.tv[sourceIndex](current.id,current.season,current.episode)+`?audio=${current.lang}`;

  playerBox.innerHTML = "";
  document.getElementById('errorMsg').textContent = "";
  playerBox.appendChild(iframe);

  iframe.onerror = () => {
    sourceIndex++;
    const max = current.type==="movie"?SOURCES.movie.length:SOURCES.tv.length;
    if(sourceIndex < max){ play(); }
    else { document.getElementById('errorMsg').textContent = "‚ö†Ô∏è Toutes les sources ont √©chou√©."; }
  }
}

// Changer source manuellement
function switchSource(){
  sourceIndex++;
  const max = current.type==="movie"?SOURCES.movie.length:SOURCES.tv.length;
  if(sourceIndex >= max) sourceIndex = 0;
  play();
  updateSourceLabel();
}

function updateSourceLabel(){
  const sources = current.type==="movie"?SOURCES.movie:SOURCES.tv;
  sourceLabel.textContent = `Source: ${sourceIndex+1}/${sources.length} | Lang: ${current.lang.toUpperCase()}`;
}

function closePlayer(){
  playerUI.style.display="none";
  playerBox.innerHTML="";
  document.getElementById('errorMsg').textContent = "";
}

loadHome();
</script>
</body>
</html>
